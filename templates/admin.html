<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Party Planner - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .header {
            background: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .campaign-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .campaign-card {
            background: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .campaign-name,
        body.dark-mode .campaign-info {
            color: #e0e0e0;
        }
        
        .campaign-card.active {
            border: 2px solid #667eea;
        }
        
        .campaign-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .badge-active {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-inactive {
            background: #f5f5f5;
            color: #757575;
        }
        
        .campaign-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .campaign-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .campaign-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            transition: background-color 0.3s;
        }
        
        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #1a1a1a;
            color: #e0e0e0;
            border-color: #444;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .players-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .player-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .stats-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            transition: background-color 0.3s;
        }
        
        body.dark-mode .stats-view {
            background: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .polls-table th {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-mode .polls-table tr:hover {
            background: #3a3a3a;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .polls-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .polls-table th,
        .polls-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .polls-table th {
            background: #f5f7fa;
            font-weight: 600;
            color: #333;
        }
        
        .polls-table tr:hover {
            background: #f5f7fa;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .campaigns-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé≤ Party Planner D&D Scheduler</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="goHome()">üè† Home</button>
            <button class="btn btn-primary" onclick="showCreateCampaign()">+ New Campaign</button>
            <button class="btn btn-secondary" onclick="showAllPolls()">üìä All Polls</button>
            <button class="btn btn-secondary" onclick="toggleDarkMode()">üåô Dark Mode</button>
            <button class="btn btn-secondary" onclick="window.location.href='/audit'">üõ° Audit Log</button>
            <button class="btn btn-secondary" onclick="window.location.href='/logout'">Logout</button>
        </div>
    </div>
    
    <div class="campaigns-grid" id="campaigns-grid"></div>
    
    <div class="stats-view" id="all-polls-view" style="display: none;">
        <div class="stats-header">
            <h2>All Polls</h2>
            <button class="btn btn-secondary" onclick="hideAllPolls()">Back</button>
        </div>
        <div id="all-polls-content"></div>
    </div>
    
    <div class="stats-view" id="stats-view">
        <div class="stats-header">
            <h2>Campaign Statistics</h2>
            <button class="btn btn-secondary" onclick="hideStats()">Back</button>
        </div>
        <div id="stats-content"></div>
    </div>
    
    <!-- Create/Edit Campaign Modal -->
    <div id="campaign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Create Campaign</h2>
                <span class="close" onclick="closeCampaignModal()">&times;</span>
            </div>
            
            <form id="campaign-form">
                <div class="form-group">
                    <label>Campaign Name</label>
                    <input type="text" id="campaign-name" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="campaign-active">
                    <label for="campaign-active" style="margin: 0;">Set as Active Campaign</label>
                </div>
                
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="campaign-start-date" required>
                </div>
                
                <div class="form-group">
                    <label>Schedule Type</label>
                    <select id="campaign-schedule-type" onchange="toggleScheduleFields()" required>
                        <option value="dynamic">Dynamic (every X days from start)</option>
                        <option value="static">Static (same weekday each period)</option>
                    </select>
                </div>
                
                <div class="form-group" id="dynamic-recurrence-group">
                    <label>Recurrence (days between sessions)</label>
                    <input type="number" id="campaign-recurrence" min="1" value="14" required>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Response Warning (Days Before)</label>
                        <input type="number" id="campaign-deadline-respond" min="1" value="14" required>
                        <small style="color: #666;">When to tag non-responders</small>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Decision Deadline (Days Before)</label>
                        <input type="number" id="campaign-deadline-decide" min="1" value="7" required>
                        <small style="color: #666;">When to announce best dates</small>
                    </div>
                </div>
                
                <div class="form-group" id="static-fields" style="display: none;">
                    <label>Day of Week</label>
                    <select id="campaign-weekday">
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                    
                    <label style="margin-top: 15px;">Recurrence (weeks between sessions)</label>
                    <input type="number" id="campaign-recurrence-weeks" min="1" value="2">
                </div>
                
                <div class="form-group">
                    <label>Session Time Start</label>
                    <input type="time" id="campaign-time-start" value="20:00" required>
                </div>
                
                <div class="form-group">
                    <label>Session Time End</label>
                    <input type="time" id="campaign-time-end" value="22:30" required>
                </div>
                
                <div class="form-group">
                    <label>Polls in Advance</label>
                    <input type="number" id="campaign-polls-advance" min="1" max="10" value="3" required>
                </div>
                
                <div class="form-group">
                    <label>Timezone</label>
                    <select id="campaign-timezone" required>
                        <option value="America/New_York">Eastern Time</option>
                        <option value="America/Chicago">Central Time</option>
                        <option value="America/Denver">Mountain Time</option>
                        <option value="America/Los_Angeles">Pacific Time</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Discord Webhook URL (optional)</label>
                    <input type="text" id="campaign-webhook">
                </div>
                
                <div class="form-group">
                    <label>Players</label>
                    <div class="players-input">
                        <input type="text" id="player-name" placeholder="Enter player name" onkeypress="if(event.key==='Enter'){event.preventDefault();addPlayer();}">
                        <div class="checkbox-group" style="white-space: nowrap; padding: 0 10px; background: #f5f5f5; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <input type="checkbox" id="player-is-dm">
                            <label for="player-is-dm" style="margin: 0; cursor: pointer;">Is DM?</label>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addPlayer()">Add</button>
                    </div>
                    <div class="players-list" id="players-list"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Campaign</button>
            </form>
        </div>
    </div>
    
    <!-- Create Poll Modal -->
    <div id="poll-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Poll</h2>
                <span class="close" onclick="closePollModal()">&times;</span>
            </div>
            
            <form id="poll-form">
                <input type="hidden" id="poll-campaign-id">
                
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="poll-start-date" required>
                </div>
                
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="poll-end-date" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="poll-send-notification">
                    <label for="poll-send-notification" style="margin: 0;">Send Discord notification?</label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Poll</button>
            </form>
        </div>
    </div>
    
    <script>
        let campaigns = [];
        let currentCampaignId = null;
        let players = [];
        
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        async function loadCampaigns() {
            const response = await fetch('/api/campaigns');
            campaigns = await response.json();
            renderCampaigns();
        }
        
        function renderCampaigns() {
            const grid = document.getElementById('campaigns-grid');
            grid.innerHTML = '';
            
            campaigns.forEach(campaign => {
                const card = document.createElement('div');
                card.className = `campaign-card ${campaign.is_active ? 'active' : ''}`;
                
                // SECURITY UPDATE: escapeHtml() added to name
                card.innerHTML = `
                    <span class="campaign-badge ${campaign.is_active ? 'badge-active' : 'badge-inactive'}">
                        ${campaign.is_active ? 'ACTIVE' : 'Inactive'}
                    </span>
                    <div class="campaign-name">${escapeHtml(campaign.name)}</div>
                    <div class="campaign-info">üë• ${campaign.player_count} players</div>
                    <div class="campaign-info">üìä ${campaign.active_polls} active polls</div>
                    <div class="campaign-info">üìÖ Every ${campaign.recurrence_days} days</div>
                    <div class="campaign-info">üïê ${campaign.session_time_start} - ${campaign.session_time_end}</div>
                    
                    <div class="campaign-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        
                        <button class="btn btn-primary" style="grid-column: span 2;" onclick="showStats(${campaign.id})">
                            üìñ Open Campaign
                        </button>
                        
                        <button class="btn btn-primary" onclick="showCampaignPolls(${campaign.id})">
                            üìã Polls
                        </button>
                        <button class="btn btn-secondary" onclick="showCreatePoll(${campaign.id})">
                            ‚ûï Poll
                        </button>
                        
                        <button class="btn btn-secondary" onclick="editCampaign(${campaign.id})">
                            ‚úèÔ∏è Edit
                        </button>
                        ${campaign.is_active ? 
                            `<button class="btn btn-secondary" onclick="endCampaign(${campaign.id})">‚è∏Ô∏è Pause</button>` : 
                            `<button class="btn btn-primary" onclick="resumeCampaign(${campaign.id})">‚ñ∂Ô∏è Resume</button>`
                        }
                        
                        <button class="btn btn-danger" style="grid-column: span 2;" onclick="deleteCampaign(${campaign.id})">
                            üóëÔ∏è Delete Campaign
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function showCreateCampaign() {
            currentCampaignId = null;
            players = [];
            document.getElementById('modal-title').textContent = 'Create Campaign';
            document.getElementById('campaign-form').reset();
            document.getElementById('players-list').innerHTML = '';
            document.getElementById('campaign-schedule-type').value = 'dynamic';
            toggleScheduleFields();
            document.getElementById('campaign-modal').style.display = 'block';
            document.getElementById('campaign-deadline-respond').value = 14;
            document.getElementById('campaign-deadline-decide').value = 7;
        }
        
        function toggleScheduleFields() {
            const scheduleType = document.getElementById('campaign-schedule-type').value;
            const dynamicGroup = document.getElementById('dynamic-recurrence-group');
            const staticFields = document.getElementById('static-fields');
            
            if (scheduleType === 'static') {
                dynamicGroup.style.display = 'none';
                staticFields.style.display = 'block';
                document.getElementById('campaign-recurrence').required = false;
                document.getElementById('campaign-weekday').required = true;
                document.getElementById('campaign-recurrence-weeks').required = true;
            } else {
                dynamicGroup.style.display = 'block';
                staticFields.style.display = 'none';
                document.getElementById('campaign-recurrence').required = true;
                document.getElementById('campaign-weekday').required = false;
                document.getElementById('campaign-recurrence-weeks').required = false;
            }
        }
        
        async function editCampaign(id) {
            currentCampaignId = id;
            const campaign = campaigns.find(c => c.id === id);
            
            document.getElementById('modal-title').textContent = 'Edit Campaign';
            document.getElementById('campaign-name').value = campaign.name;
            document.getElementById('campaign-active').checked = campaign.is_active;
            document.getElementById('campaign-start-date').value = campaign.start_date;
            document.getElementById('campaign-schedule-type').value = campaign.schedule_type || 'dynamic';
            
            if (campaign.schedule_type === 'static') {
                document.getElementById('campaign-weekday').value = campaign.weekday || 3;
                document.getElementById('campaign-recurrence-weeks').value = campaign.recurrence_days / 7;
            } else {
                document.getElementById('campaign-recurrence').value = campaign.recurrence_days;
            }
            
            toggleScheduleFields();
            
            document.getElementById('campaign-time-start').value = campaign.session_time_start;
            document.getElementById('campaign-time-end').value = campaign.session_time_end;
            document.getElementById('campaign-polls-advance').value = campaign.polls_in_advance;
            document.getElementById('campaign-timezone').value = campaign.timezone;
            
            // --- ADD THIS LINE HERE ---
            document.getElementById('campaign-webhook').value = campaign.discord_webhook || '';
            // --------------------------

            document.getElementById('campaign-deadline-respond').value = campaign.deadline_respond || 14;
            document.getElementById('campaign-deadline-decide').value = campaign.deadline_decide || 7;
            
            // Load players for this campaign
            const response = await fetch(`/api/campaigns/${id}/players`);
            const data = await response.json();
            players = data.players || [];
            renderPlayers();
            
            document.getElementById('campaign-modal').style.display = 'block';
        }
        
        function closeCampaignModal() {
            document.getElementById('campaign-modal').style.display = 'none';
        }
        
        function addPlayer() {
            const input = document.getElementById('player-name');
            const isDmCheckbox = document.getElementById('player-is-dm');
            const name = input.value.trim();
            const isDm = isDmCheckbox.checked;
            
            if (name && !players.some(p => p.name === name)) {
                // If this player is DM, ensure no one else is (optional strictness, or allow co-DMs)
                // For now, we allow multiple DMs or just one. Let's stick to list logic.
                players.push({ name: name, is_dm: isDm });
                renderPlayers();
                input.value = '';
                isDmCheckbox.checked = false;
            }
        }
        
        function removePlayer(name) {
            players = players.filter(p => p.name !== name);
            renderPlayers();
        }
        
        function renderPlayers() {
            const list = document.getElementById('players-list');
            list.innerHTML = '';
            
            players.forEach(player => {
                const tag = document.createElement('div');
                tag.className = 'player-tag';
                const dmBadge = player.is_dm ? '<span style="background:#ff9800; color:white; padding:2px 6px; border-radius:10px; font-size:10px; margin-right:5px;">DM</span>' : '';
                
                // SECURITY UPDATE: escapeHtml() added to name
                tag.innerHTML = `
                    ${dmBadge}${escapeHtml(player.name)}
                    <span class="remove" onclick="removePlayer('${escapeHtml(player.name).replace(/'/g, "\\'")}')">√ó</span>
                `;
                list.appendChild(tag);
            });
        }
        
        document.getElementById('campaign-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ... (keep variable gathering logic: scheduleType, recurrenceDays, data object) ...
            // Note: Copy the variable gathering logic from your existing file, 
            // we are just updating the fetch call below:

            const scheduleType = document.getElementById('campaign-schedule-type').value;
            let recurrenceDays, weekday = null;
            
            if (scheduleType === 'static') {
                weekday = parseInt(document.getElementById('campaign-weekday').value);
                recurrenceDays = parseInt(document.getElementById('campaign-recurrence-weeks').value) * 7;
            } else {
                recurrenceDays = parseInt(document.getElementById('campaign-recurrence').value);
            }
            
            const data = {
                name: document.getElementById('campaign-name').value,
                is_active: document.getElementById('campaign-active').checked,
                start_date: document.getElementById('campaign-start-date').value,
                schedule_type: scheduleType,
                recurrence_days: recurrenceDays,
                weekday: weekday,
                session_time_start: document.getElementById('campaign-time-start').value,
                session_time_end: document.getElementById('campaign-time-end').value,
                polls_in_advance: parseInt(document.getElementById('campaign-polls-advance').value),
                timezone: document.getElementById('campaign-timezone').value,
                discord_webhook: document.getElementById('campaign-webhook').value,
                deadline_respond: parseInt(document.getElementById('campaign-deadline-respond').value),
                deadline_decide: parseInt(document.getElementById('campaign-deadline-decide').value),
                players: players
            };

            const url = currentCampaignId 
                ? `/api/campaigns/${currentCampaignId}`
                : '/api/campaigns';
            
            const method = currentCampaignId ? 'PUT' : 'POST';
            
            await fetch(url, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // <--- Added Header
                },
                body: JSON.stringify(data)
            });
            
            closeCampaignModal();
            loadCampaigns();
        });
        
        async function deleteCampaign(id) {
            if (!confirm('Are you sure you want to delete this campaign? This will also delete all associated polls and responses.')) {
                return;
            }
            
            await fetch(`/api/campaigns/${id}`, { 
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken } // <--- Added Header
            });
            loadCampaigns();
        }
        
        async function endCampaign(id) {
            const campaign = campaigns.find(c => c.id === id);
            
            // Create a modal for end campaign options
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>End Campaign: ${campaign.name}</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <p style="margin-bottom: 20px;">What would you like to do with open polls?</p>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button class="btn btn-primary" onclick="endCampaignAction(${id}, 'keep')" style="width: 100%;">
                            Keep Open Polls (Just deactivate campaign)
                        </button>
                        <button class="btn btn-danger" onclick="endCampaignAction(${id}, 'delete')" style="width: 100%;">
                            Delete All Open Polls
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="width: 100%;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function endCampaignAction(id, action) {
            document.querySelector('.modal').remove();
            const campaign = campaigns.find(c => c.id === id);
            const response = await fetch(`/api/campaigns/${id}/players`);
            const data = await response.json();
            
            await fetch(`/api/campaigns/${id}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // <--- Added Header
                },
                body: JSON.stringify({
                    // ... (keep existing body params) ...
                    name: campaign.name,
                    is_active: false,
                    start_date: campaign.start_date,
                    recurrence_days: campaign.recurrence_days,
                    session_time_start: campaign.session_time_start,
                    session_time_end: campaign.session_time_end,
                    polls_in_advance: campaign.polls_in_advance,
                    timezone: campaign.timezone,
                    discord_webhook: campaign.discord_webhook || '',
                    players: data.players
                })
            });
            
            if (action === 'delete') {
                const pollsResponse = await fetch('/api/polls/all');
                const pollsData = await pollsResponse.json();
                const openPolls = pollsData.polls.filter(p => p.campaign_id === id && !p.is_closed);
                
                for (const poll of openPolls) {
                    await fetch(`/api/polls/${poll.slug}`, { 
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrfToken } // <--- Added Header
                    });
                }
            }
            loadCampaigns();
        }
        
        async function resumeCampaign(id) {
            if (!confirm('Resume this campaign? This will deactivate any other active campaigns and start generating new polls.')) {
                return;
            }
            const campaign = campaigns.find(c => c.id === id);
            const response = await fetch(`/api/campaigns/${id}/players`);
            const data = await response.json();
            
            await fetch(`/api/campaigns/${id}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // <--- Added Header
                },
                body: JSON.stringify({
                    // ... (keep existing body params) ...
                    name: campaign.name,
                    is_active: true,
                    start_date: campaign.start_date,
                    recurrence_days: campaign.recurrence_days,
                    session_time_start: campaign.session_time_start,
                    session_time_end: campaign.session_time_end,
                    polls_in_advance: campaign.polls_in_advance,
                    timezone: campaign.timezone,
                    discord_webhook: campaign.discord_webhook || '',
                    players: data.players
                })
            });
            loadCampaigns();
        }
        
        function showCreatePoll(campaignId) {
            document.getElementById('poll-campaign-id').value = campaignId;
            document.getElementById('poll-form').reset();
            document.getElementById('poll-modal').style.display = 'block';
        }
        
        function closePollModal() {
            document.getElementById('poll-modal').style.display = 'none';
        }
        
        document.getElementById('poll-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                campaign_id: parseInt(document.getElementById('poll-campaign-id').value),
                start_date: document.getElementById('poll-start-date').value,
                end_date: document.getElementById('poll-end-date').value,
                send_notification: document.getElementById('poll-send-notification').checked,
                is_manual: true
            };
            
            await fetch('/api/polls', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // <--- Added Header
                },
                body: JSON.stringify(data)
            });
            
            closePollModal();
            loadCampaigns();
        });
        
        async function showStats(campaignId) {
            const response = await fetch(`/api/campaigns/${campaignId}/stats`);
            const data = await response.json();
            
            document.getElementById('campaigns-grid').style.display = 'none';
            document.getElementById('stats-view').style.display = 'block';
            
            let html = `
                <h3>${data.campaign.name}</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Sessions</div>
                        <div class="stat-value">${data.total_sessions}</div>
                    </div>
                    ${data.best_date_info ? `
                        <div class="stat-card">
                            <div class="stat-label">Most Common Day</div>
                            <div class="stat-value">${data.best_date_info.weekday}</div>
                            <div class="stat-label" style="margin-top: 5px;">${data.best_date_info.count} of ${data.best_date_info.total} sessions</div>
                        </div>
                    ` : ''}
                </div>
                
                ${data.next_poll ? `
                    <div class="stat-card">
                        <div class="stat-label">Next Session Poll</div>
                        <div class="stat-value">Session ${data.next_poll.session_number}</div>
                        <div class="stat-label" style="margin-top: 10px;">${data.next_poll.start_date} to ${data.next_poll.end_date}</div>
                        <button class="btn btn-secondary" style="margin-top: 10px;" onclick="window.location.href='/poll/${data.next_poll.slug}'">View Poll</button>
                    </div>
                ` : ''}
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">Player Attendance</h4>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Sessions Attended</th>
                            <th>Attendance Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.player_attendance.map(player => `
                            <tr>
                                <td><strong>${player.name}</strong></td>
                                <td>${player.attended} / ${player.total}</td>
                                <td>${player.percentage}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">Active Polls</h4>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Date Range</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.active_polls.map(poll => `
                            <tr>
                                <td>Session ${poll.session_number}</td>
                                <td>${poll.start_date} to ${poll.end_date}</td>
                                <td>${poll.response_rate}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="window.location.href='/poll/${poll.slug}'">View Poll</button>
                                    <button class="btn btn-danger" onclick="deletePollFromList('${poll.slug}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">Past Sessions</h4>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.past_sessions.map(poll => `
                            <tr>
                                <td>Session ${poll.session_number}</td>
                                <td>${poll.selected_date}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('stats-content').innerHTML = html;
        }
        
        function hideStats() {
            document.getElementById('campaigns-grid').style.display = 'grid';
            document.getElementById('stats-view').style.display = 'none';
        }
        
        async function showAllPolls() {
            const response = await fetch('/api/polls/all');
            const data = await response.json();
            
            document.getElementById('campaigns-grid').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('all-polls-view').style.display = 'block';
            
            const openPolls = data.polls.filter(p => !p.is_closed);
            const closedPolls = data.polls.filter(p => p.is_closed);
            
            let html = `
                <h3 style="margin-bottom: 20px;">Open Polls (${openPolls.length})</h3>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Session</th>
                            <th>Date Range</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${openPolls.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: #999;">No open polls</td></tr>' : ''}
                        ${openPolls.map(poll => `
                            <tr>
                                <td><strong>${poll.campaign_name}</strong></td>
                                <td>Session ${poll.session_number}</td>
                                <td>${poll.start_date} to ${poll.end_date}</td>
                                <td>${poll.response_count}/${poll.player_count}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="window.location.href='/poll/${poll.slug}'">View Poll</button>
                                    <button class="btn btn-danger" onclick="deletePollFromList('${poll.slug}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <h3 style="margin-top: 40px; margin-bottom: 20px;">Closed Polls (${closedPolls.length})</h3>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Session</th>
                            <th>Date Range</th>
                            <th>Selected Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${closedPolls.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: #999;">No closed polls</td></tr>' : ''}
                        ${closedPolls.map(poll => `
                            <tr>
                                <td><strong>${poll.campaign_name}</strong></td>
                                <td>Session ${poll.session_number}</td>
                                <td>${poll.start_date} to ${poll.end_date}</td>
                                <td>
                                    ${poll.selected_date 
                                        ? `<strong>${poll.selected_date}</strong>` 
                                        : '<span style="color: #f44336; font-weight:bold;">Cancelled</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-secondary" onclick="window.location.href='/poll/${poll.slug}'">View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('all-polls-content').innerHTML = html;
        }
        
        function hideAllPolls() {
            document.getElementById('campaigns-grid').style.display = 'grid';
            document.getElementById('all-polls-view').style.display = 'none';
        }
        
        function goHome() {
            document.getElementById('campaigns-grid').style.display = 'grid';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('all-polls-view').style.display = 'none';
            loadCampaigns();
        }
        
        async function showCampaignPolls(campaignId) {
            const response = await fetch('/api/polls/all');
            const data = await response.json();
            
            const campaign = campaigns.find(c => c.id === campaignId);
            const campaignPolls = data.polls.filter(p => p.campaign_id === campaignId);
            
            document.getElementById('campaigns-grid').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('all-polls-view').style.display = 'block';
            
            const openPolls = campaignPolls.filter(p => !p.is_closed);
            const closedPolls = campaignPolls.filter(p => p.is_closed);
            
            let html = `
                <h3 style="margin-bottom: 20px;">${campaign.name} - Campaign Polls</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showCreatePoll(${campaignId})">+ Add Poll</button>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Open Polls (${openPolls.length})</h4>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Date Range</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${openPolls.length === 0 ? '<tr><td colspan="4" style="text-align: center; color: #999;">No open polls</td></tr>' : ''}
                        ${openPolls.map(poll => `
                            <tr>
                                <td><strong>Session ${poll.session_number}</strong></td>
                                <td>${poll.start_date} to ${poll.end_date}</td>
                                <td>${poll.response_count}/${poll.player_count}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="window.location.href='/poll/${poll.slug}'">View Poll</button>
                                    <button class="btn btn-danger" onclick="deletePollFromList('${poll.slug}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <h3 style="margin-top: 40px; margin-bottom: 20px;">Closed Polls (${closedPolls.length})</h3>
                <table class="polls-table">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Date Range</th>
                            <th>Selected Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${closedPolls.length === 0 ? '<tr><td colspan="4" style="text-align: center; color: #999;">No closed polls</td></tr>' : ''}
                        ${closedPolls.map(poll => `
                            <tr>
                                <td><strong>Session ${poll.session_number}</strong></td>
                                <td>${poll.start_date} to ${poll.end_date}</td>
                                <td>
                                    ${poll.selected_date 
                                        ? `<strong>${poll.selected_date}</strong>` 
                                        : '<span style="color: #f44336; font-weight:bold;">Cancelled</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-primary" onclick="window.location.href='/poll/${poll.slug}'">View Poll</button>
                                    <button class="btn btn-danger" onclick="deletePollFromList('${poll.slug}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('all-polls-content').innerHTML = html;
        }
        
        async function deletePollFromList(slug) {
            if (!confirm('Are you sure you want to delete this poll?')) { return; }
            
            try {
                await fetch(`/api/polls/${slug}`, { 
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken } // <--- Added Header
                });
                
                await loadCampaigns();
                // ... (keep existing refresh logic) ...
                if (document.getElementById('all-polls-view').style.display === 'block') {
                     // We're in campaign-specific view, extract campaign ID
                    const header = document.querySelector('#all-polls-content h3');
                    if (header && header.textContent.includes(' - Campaign Polls')) {
                        const campaignName = header.textContent.split(' - Campaign Polls')[0];
                        const campaign = campaigns.find(c => c.name === campaignName);
                        if (campaign) {
                            showCampaignPolls(campaign.id);
                        }
                    } else {
                        showAllPolls();
                    }
                }
            } catch (error) {
                console.error('Error during delete operation:', error);
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            // Update button text
            const btn = event.target;
            btn.textContent = isDark ? '‚òÄ Light Mode' : 'üåô Dark Mode';
        }
        
        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            // Will update button text after page loads
        }
        
        // Load campaigns on page load
        loadCampaigns();
    </script>
</body>
</html>